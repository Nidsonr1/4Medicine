<div class="reports-header">
  <div class="reports-header-title">
    <button
      nz-button
      nzType="primary"
      nzShape="circle"
      routerLink="/inicio"
      nz-tooltip
      nzTooltipPlacement="bottom"
      nzTooltipTitle="Voltar"
    >
      <span nz-icon nzType="caret-left" nzTheme="outline"></span>
    </button>
    <h3>Laudos médicos</h3>
  </div>

  <div class="reports-header-actions" *ngIf="userLogged === 'doctor'">
    <button nz-button nzType="primary" (click)="newReport()">
      <span nz-icon nzType="file-add" nzTheme="outline"></span>
      Novo laudo
    </button>

    <button
      class="desktop mobile"
      nz-button
      nzShape="circle"
      nzType="primary"
      (click)="newReport()"
    >
      <span nz-icon nzType="file-add" nzTheme="outline"></span>
    </button>
  </div>
</div>

<div class="reports-doctor" *ngIf="userLogged === 'doctor'">
  <nz-table class="reports-table" [nzData]="dataTableReportsDoctors">
    <thead>
      <tr>
        <th>Paciente</th>
        <th>Idade</th>
        <th>Laudo</th>
        <th [nzSortFn]="true">Data de upload</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let row of dataTableReportsDoctors">
        <td>
          {{ row.patient.name }}
          <a
            nz-button
            nzType="link"
            nz-tooltip
            nzTooltipTitle="Sobre o paciente"
            (click)="aboutPatient(row)"
            ><span nz-icon nzType="file-search" nzTheme="outline"></span
          ></a>
        </td>
        <td>{{ calculateAge(row.patient.dateOfBirth) }}</td>
        <td>{{ row.documentTitle }}</td>
        <td>{{ formatDate(row.createdAt) }}</td>
        <td>
          <a
            nz-button
            nzType="link"
            nz-tooltip
            nzTooltipTitle="Ver o PDF"
            (click)="openReport(row)"
            ><span nz-icon nzType="file-pdf" nzTheme="outline"></span
          ></a>
        </td>
      </tr>
    </tbody>
  </nz-table>
</div>

<div class="reports-patient" *ngIf="userLogged === 'patient'">
  <nz-table class="reports-patient-table" [nzData]="dataTableReportsPatients">
    <thead>
      <tr>
        <th>Médico responsavel</th>
        <th>Especialidade(s)</th>
        <th>Laudo</th>
        <th [nzSortFn]="true">Data de upload</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let row of dataTableReportsPatients">
        <td>{{ row.doctor.name }}</td>
        <td>
          <span
            class="reports-patient-table-badge"
            *ngFor="let expertise of formatArray(row.doctor.expertise)"
            >{{ expertise.label }}</span
          >
        </td>
        <td>{{ row.documentTitle }}</td>
        <td>{{ formatDate(row.createdAt) }}</td>
        <td>
          <a
            nz-button
            nzType="link"
            nz-tooltip
            nzTooltipTitle="Ver o PDF"
            (click)="openReport(row)"
            ><span nz-icon nzType="file-pdf" nzTheme="outline"></span
          ></a>
          <a
            nz-button
            nzType="link"
            nz-tooltip
            nzTooltipTitle="Compartilhar com médicos"
            (click)="shareReport(row)"
            ><span nz-icon nzType="share-alt" nzTheme="outline"></span
          ></a>
          <a
            nz-button
            nzType="link"
            nz-tooltip
            nzTooltipTitle="Lista de acessos"
            nz-popover
            nzPopoverTrigger="click"
            nzPopoverPlacement="bottom"
            nzPopoverTitle="O laudo pode ser acessado por:"
            [nzPopoverContent]="sharedBy"
            ><span nz-icon nzType="user-switch" nzTheme="outline"></span
          ></a>

          <ng-template class="reports-patient-table-sharedBy" #sharedBy>
            <div
              *ngFor="let whoCanAccess of formatArray(row.sharedBy)"
              class="reports-patient-table-sharedBy-item"
            >
              <p>
                {{ whoCanAccess.label }}
              </p>
              <button
                nz-button
                nzType="text"
                (click)="unsharedReports(whoCanAccess.label, row.id)"
              >
                <img src="assets/png/unsharedIcon.png" width="16" />
              </button>
            </div>
            <p *ngIf="!formatArray(row.sharedBy).length">
              <span nz-icon nzType="eye-invisible" nzTheme="outline"></span>
              Ninguém por enquanto
            </p>
          </ng-template>
        </td>
      </tr>
    </tbody>
  </nz-table>
</div>

<div class="table-pagination">
  <nz-pagination
    (nzPageIndexChange)="onCurrentPageDataChange($event)"
    [nzTotal]="totalItemsTable"
    [nzPageSize]="limitPerPage"
    [(nzPageIndex)]="indexPageTable"
  ></nz-pagination>
</div>
